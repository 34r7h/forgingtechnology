"use strict";angular.module("numetal",["ngAnimate","ngAria","ngResource","ngSanitize","ngTouch","ui.router","ngFabForm","firebase"]),angular.module("numetal").directive("admin",function(){return{templateUrl:"scripts/admin/admin-d.html",restrict:"EA",controller:["$scope","$attrs",function(e,t){e.$parent.admin.s.type=t.type,e.$parent.admin.s.section=t.section}]}}),angular.module("numetal").directive("connect",function(){return{templateUrl:"scripts/connect/connect-d.html",restrict:"EA",link:function(e,t,n){},controller:["$scope",function(e){}]}}),angular.module("numetal").directive("content",function(){return{templateUrl:"scripts/content/content-d.html",restrict:"EA",controller:["$scope","$attrs",function(e,t){e.$parent.metal.s.type=t.type}]}}),angular.module("numetal").directive("contentSingle",["$state",function(e){return{templateUrl:"scripts/content-single/content-single-d.html",restrict:"EA",controller:["$scope","$attrs",function(t,n){t.$parent.metal.s.type=n.type,t.$parent.metal.s.params=e.params[t.$parent.metal.s.type]}]}}]),angular.module("numetal").directive("gallery",function(){return{templateUrl:"scripts/gallery/gallery-d.html",restrict:"EA",link:function(e,t,n){},controller:["$scope",function(e){}]}}),angular.module("numetal").directive("layout",function(){return{templateUrl:"scripts/layout/layout-d.html",restrict:"EA",link:function(e,t,n){},controller:["$scope",function(e){}]}}),angular.module("numetal").factory("Api",["$http","$state","Data","$firebaseObject","$firebaseAuth","$timeout","State","$rootScope",function(e,t,n,o,a,s,i,c){c.debug=!0;var l={login:function(e,t){var o=a(n.refs.fb);o.$authWithPassword({email:e,password:t}).then(function(e){console.log("Logged in as:",e.uid),i.auth=e})["catch"](function(e){console.error("Authentication failed:",e)})},logout:function(){i.auth.$unauth(),i.auth=null},log:function(e,t){return c.debug?"object"==typeof e?angular.forEach(e,function(e,n){console.log("%c"+n+": "+e,"background:#aaaaaa; color:#fefefe, padding:10px",t)}):console.log("%c"+e,"background:#aaaaaa; color:#fefefe, padding:10px",t):null},copy:function(e){return angular.copy(e)},get:function(t){var n={};return e.get(t).then(function(e){n.data=e}),n},go:function(e,n){t.go(e,n),t.reload(e)},add:function(e,t){function o(){t.updated=Date.now(),t.publish=t.publish?t.publish:!0,n.object[e]?null:n.object[e]={},n.array[e].$add(t).then(function(o){function a(){angular.forEach(t.tags,function(e){-1===s.indexOf(e)?s.push(e):null,n.object.index.tags?null:n.object.index.tags={},n.object.index.tags[e]?n.object.index.tags[e][o.key()]=!0:(n.object.index.tags[e]={},n.object.index.tags[e][o.key()]=!0)}),t.tags=s}n.object.index?null:n.object.index={},n.object.posts?null:n.object.posts={},n.object.index[e]?null:n.object.index[e]={},t.section?n.object.index.sections?null:n.object.index.sections={}:null,t.section?n.object.index.sections[t.section]?n.object.index.sections[t.section][o.key()]=!0:(n.object.index.sections[t.section]={},n.object.index.sections[t.section][o.key()]=!0):null,n.object.index[e][o.key()]=!0;var s=["metal"];t.tags=t.tags?a():s,n.object.posts[o.key()]=e,n.object.$save()})}function a(){console.error("New entries must have a name")}t.name?o():a()},rm:function(e,t){function a(){var a={bucket:"forgingtechnologies.com",access_key:"AKIAIYGVTJVFY77MNYCQ",secret_key:"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"};AWS.config.update({accessKeyId:a.access_key,secretAccessKey:a.secret_key}),AWS.config.region="us-west-2";var s=new AWS.S3,i={Bucket:a.bucket,Key:n.object[e][t].name};s.deleteObject(i,function(e,t){t||console.log("Check if you have sufficient permissions : "+e)}),n.media=o(n.refs.media).$loaded().then(function(o){n.object.media[t].tags?angular.forEach(n.object.media[t].tags,function(e){n.object.index.tags[e][t]=null}):null,o[n.object[e][t].name.replace(".","`")]=null,n.object[e][t]=null,n.object.posts[t]=null,n.object.index.media[t]=null,n.object.$save(),o.$save()})}function s(){angular.forEach(n.object.content[t].tags,function(e){n.object.index.tags[e][t]=null}),n.object.index.sections[n.object.content[t].section][t]=null,n.object[e][t]=null,n.object.index[e][t]=null,n.object.posts[t]=null,n.object.$save()}"media"===e?a():null,"media"!==e?s():null},saveSite:function(e){var t=o(n.refs.fb);t.site=e,t.$save().then(function(e){e.key()===t.$id},function(e){console.log("Error:",e)})},save:function(e,t,a,i){function c(){o(n.refs.fb.child(e)).$loaded().then(function(e){e[t]=a,e.$save().then(function(n){return e[t]},function(e){console.log("Error:",e)})})}function l(){d.tags&&d.sections?c():s(function(){l()},1e3)}function r(){return a.section!==i.section?(n.object.index.sections[i.section][t]=null,n.object.index.sections[a.section][t]=!0):null,d.sections=!0}function u(){console.log("checking tags",i.tags,a.tags);var e=[];return angular.forEach(a.tags,function(o){n.object.index.tags?null:n.object.index.tags={},-1===e.indexOf(o)?e.push(o):null,n.object.index.tags[o]?null:n.object.index.tags[o]={},n.object.index.tags[o][t]=!0}),angular.forEach(e,function(e){angular.forEach(i.tags,function(o){console.log(e,o),a.tags.indexOf(o)<0?n.object.index.tags[o][t]=null:null})}),a.tags=e,n.object.$save(),d.tags=!0}var d={};return a?null:a=n.object[e][t],i?null:i=a,JSON.stringify(i.tags)!==JSON.stringify(a.tags)?u():d.tags=!0,JSON.stringify(i.section)!==JSON.stringify(a.section)?r():d.sections=!0,l(),a},msg:function(e){var t=performance.now();console.log(performance.now()-t,e)}};return l}]),angular.module("numetal").factory("Data",["$firebaseObject","$firebaseArray","$firebaseAuth",function(e,t,n){for(var o="https://sizzling-fire-2548.firebaseio.com/data",a="https://sizzling-fire-2548.firebaseio.com/media",s=new Firebase(o),i=new Firebase(o).child("content"),c=new Firebase(a),l=e(s),r=["content","site","media","posts","index"],u={},d=r.length-1;d>=0;d--)u[r[d]]=t(s.child(r[d]));var f={index:{},object:{},array:[],refs:{media:c,fb:s,content:i}};return l.$loaded().then(function(e){f.object=e,f.array=u}),f}]),angular.module("numetal").factory("Facts",["Api","Data","State","Ux",function(e,t,n,o){for(;!(e&&t&&n&&o);)console.log("Awaiting DI");var a={api:e,data:t,state:n,ux:o};return a}]),angular.module("numetal").factory("State",["$state",function(e){var t={state:e,params:e.params,current:e.current,data:{},show:{}};return t}]),angular.module("numetal").factory("Ux",["$window",function(e){var t={xy:function(){return[e.innerWidth,e.innerHeight]}};return t}]),angular.module("numetal").directive("posts",function(){return{templateUrl:"scripts/posts/posts-d.html",restrict:"EA",link:function(e,t,n){},controller:["$scope",function(e){}]}}),angular.module("numetal").directive("postsSingle",function(){return{templateUrl:"scripts/posts-single/posts-single-d.html",restrict:"EA",link:function(e,t,n){},controller:["$scope",function(e){}]}}),angular.module("numetal").config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,n){n.hashPrefix("!"),t.otherwise("/"),e.state("metal",{url:"",template:"<layout></layout>","abstract":!0,controller:["Facts",function(e){var t=this;t.a=e.api,t.d=e.data,t.s=e.state,t.u=e.ux}],controllerAs:"metal"}).state("metal.home",{url:"/",template:"<posts></posts>"}).state("metal.about",{url:"/about",template:'<content section="about" type="about"></content>'}).state("metal.about.about",{url:"/:about",template:'<content-single type="about" section="about"></content-single>'}).state("metal.services",{url:"/services",template:'<content type="services" section="services"></content>'}).state("metal.services.services",{url:"/:services",template:'<content-single type="services" section="services"></content-single>'}).state("metal.clients",{url:"/clients",template:'<content type="clients" section="clients"></content>'}).state("metal.clients.clients",{url:"/:clients",template:'<content-single type="clients" section="clients"></content-single>'}).state("metal.posts",{url:"/posts",template:'<content section="posts" type="posts"></content>'}).state("metal.posts.posts",{url:"/:posts",template:'<content-single section="posts" type="posts"></content-single>'}).state("metal.gallery",{url:"/gallery",template:'<content section="gallery" type="gallery"></content>'}).state("metal.gallery.gallery",{url:"/:gallery",template:'<content-single section="gallery" type="gallery"></content-single>'}).state("admin",{url:"/admin",template:"<ui-view></ui-view>",controller:["Facts",function(e){var t=this;t.a=e.api,t.d=e.data,t.s=e.state,t.u=e.ux}],controllerAs:"admin"}).state("admin.site",{url:"/site",template:'<admin type="site"></admin>',onEnter:["State",function(e){e.show.editSite=!0}],onExit:["State",function(e){e.show.editSite=!1}]}).state("admin.services",{url:"/services",template:'<admin type="services"></admin>'}).state("admin.clients",{url:"/clients",template:'<admin type="clients"></admin>'}).state("admin.media",{url:"/media",template:'<admin type="media"></admin>',onEnter:["State",function(e){e.show.showMedia=!0}],onExit:["State",function(e){e.show.showMedia=!1}]}).state("admin.posts",{url:"/posts",template:'<admin type="posts"></admin>',onEnter:["State",function(e){e.show.editPosts=!0}],onExit:["State",function(e){e.show.editPosts=!1}]})}]);var AWS=AWS;angular.module("numetal").directive("uploader",function(){return{restrict:"AE",templateUrl:"scripts/uploader/uploader-d.html",scope:{file:"@"},controller:["$scope","Api","$firebaseObject","Data","$timeout",function(e,t,n,o,a){e.uploadS3=function(){var s;console.info("Begin Uploading to S3",s=performance.now()),AWS.config.update({accessKeyId:e.creds.access_key,secretAccessKey:e.creds.secret_key}),AWS.config.region="us-west-2";var i=new AWS.S3({params:{Bucket:e.creds.bucket}}),c=Date.now(),l=[],r=n(o.refs.media);if(e.files.length)for(var u=[],d=[],f=[],g=e.files.length-1;g>=0;g--){d[g]=c+"-"+e.files[g].name,u[g]=e.files[g].type;var m={Key:d[g],ContentType:u[g],Body:e.files[g],ServerSideEncryption:"AES256"};i.putObject(m,function(t,n){return t?(console.error(t.message,t.code),!1):void setTimeout(function(){e.uploadProgress=0,e.$digest()},4e3)}).on("httpUploadProgress",function(t){e.uploadProgress=Math.round(t.loaded/t.total*100),e.$digest()}),f[g]=new FileReader,f[g].onload=function(e,t){return f[t].readAsDataURL(e),function(e){!function(n){var o=document.createElement("canvas"),s=o.getContext("2d"),i=n,c=new Image;c.src=i;var u=160,f=c.width/u;return o.width=u,o.height=c.height/f,s.drawImage(c,0,0,o.width,o.height),l[t]=o.toDataURL("image/jpeg",.75),r.$loaded().then(function(e){e[d[t].replace(".","`")]=l[t],a(e.$save(),5e3)}),e.target.result}(e.target.result)}}(e.files[g],g),t.add("media",{src:"https://s3-us-west-2.amazonaws.com/forgingtechnologies.com/"+d[g],type:u[g],name:d[g]})}else console.error("Please select a file to upload");console.info("End Upload to S3",performance.now()-s)}}],link:function(e,t,n){e.creds={bucket:"forgingtechnologies.com",access_key:"AKIAIYGVTJVFY77MNYCQ",secret_key:"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"},t.bind("change",function(t){var n=t.target.files,o=n[0];e.files=n,e.file=o,e.$parent.file=o,e.$apply()})}}});